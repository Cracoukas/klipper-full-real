[include .dynamicmacros.cfg]
# [heater# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

# See docs/Config_Reference.md for a description of parameters.

########################################################################
#   GLOBAL VARIABLES
########################################################################
### 

[delayed_gcode boot_macro]
initial_duration: 1.0
gcode:
  M118 [Welcome: boot_macro]
  CLEAR_PAUSE
  GLOBALS_V

  {% set svv = printer.save_variables.variables %}
  SET_GCODE_VARIABLE  MACRO=GLOBALS_V VARIABLE=extruder_parked  VALUE={svv.extruder_parked} 

  SET_GCODE_VARIABLE  MACRO=GLOBALS_V VARIABLE=tap_mode  VALUE={svv.tap_mode} 
  SET_GCODE_VARIABLE  MACRO=GLOBALS_V VARIABLE=eddy_mode  VALUE={svv.eddy_mode} 
  SET_GCODE_VARIABLE  MACRO=GLOBALS_V VARIABLE=carto_mode  VALUE={svv.carto_mode} 
  
[gcode_macro GLOBALS_V]
variable_extruder_parked : 0
variable_z_pos: -10
# variable_hotend_type : "V6"
variable_hotend_type : "revo"
variable_tap_mode : 1
variable_eddy_mode : 0
variable_carto_mode : 0

gcode:
  M118 globals defined
  M118   default extruder_parked = {extruder_parked}
  M118   default z_pos = {z_pos}
  M118   default tap_mode = {tap_mode}
  M118   default eddy_mode = {eddy_mode}
  M118   default carto_mode = {carto_mode}


# [gcode_macro SET_GLOBAL]
# gcode:
#   M118 macro SET_GLOBAL  params.VALUE = { params.VALUE}
#   SET_GCODE_VARIABLE MACRO=GLOBALS_V VARIABLE=z_pos VALUE={ params.VALUE|float }
 
[save_variables]
filename: ../printer_data/config/variables.cfg
# filename: ~/printer_data/config/firstlayer_vars.cfg
# filename: ~/printer_data/config/firstlayer_vars.cfg

#   Required - provide a filename that would be used to save the
#   variables to disk e.g. ~/variables.cfg


[include mainsail.cfg]
[include moonraker_obico_macros.cfg]
###! [include stealthburner_leds.cfg]

[include homing.cfg]     # does not seems to be used if used as dynamic
[include macros.cfg]
[include speed.cfg]
[include pause.cfg]
# [include dynamic.cfg]

# [include tmc2209.cfg]                        # x/Y/Z axes tmc2209 configu
[include tmc5160.cfg]                          # x/Y/Z axes tmc5160 configuration

##--------------------------
##  select probing mode
##--------------------------
# {% if  printer["gcode_macro GLOBALS_V"].tap_mode == 1 %}
#   ##  use TAP only for probing
[include tap_config.cfg]
# {% elif  printer["gcode_macro GLOBALS_V"].eddy_mode == 1 %}
#   ## use Eddy for probing and eddy for bedmesh
#   [include eddy_config.cfg]  
# {% elif  printer["gcode_macro GLOBALS_V"].carto_mode == 1 %}
#   ## use Cartograpfer for probing and eddy for bedmesh
# [include carto_mesh.cfg]
# {% endif %}
# ##--------------------------

###  [include shell_command.cfg]
[include autotune.cfg]
[include autospeed.cfg]

# First layer optomisation
[include FirstLayer.cfg]

[force_move]
enable_force_move: True

#####################################################################
#   UUID Setting
#####################################################################

[mcu]
#canbus_uuid:
#   If using a device connected to a CAN bus then this sets the unique
#   chip identifier to connect to. This value must be provided when using
#   CAN bus for communication.
#   ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
#   Found canbus_uuid=b2e403d392fe, Application: Klipper
#   https://gist.github.com/fredrikasberg/c14f08eb8617bf8981f77dbc01b00602
canbus_uuid: b2e403d392fe  # Detected UUID: b2e403d392fe, Application: Klipper

#canbus_interface:
#   If using a device connected to a CAN bus then this sets the CAN
#   network interface to use. The default is 'can0'.
canbus_interface: can0

#restart_method:
#   This controls the mechanism the host will use to reset the
#   micro-controller. The choices are 'arduino', 'cheetah', 'rpi_usb',
#   and 'command'. The 'arduino' method (toggle DTR) is common on
#   Arduino boards and clones. The 'cheetah' method is a special
#   method needed for some Fysetc Cheetah boards. The 'rpi_usb' method
#   is useful on Raspberry Pi boards with micro-controllers powered
#   over USB - it briefly disables power to all USB ports to
#   accomplish a micro-controller reset. The 'command' method involves
#   sending a Klipper command to the micro-controller so that it can
#   reset itself. The default is 'arduino' if the micro-controller
#   communicates over a serial port, 'command' otherwise.


[mcu EBBCan]
##serial: /dev/serial/by-id/usb-Klipper_Klipper_firmware_12345-if00
canbus_uuid: 4cb54f84a8fd       #  Detected UUID: c76167775bb3, Application: Klipper EBB36
# canbus_uuid: 9567318eb8a2     # Detected UUID: 9567318eb8a2, Application: Klipper  EBB2209 !
canbus_interface: can0


#####################################################################
#  Voron R2.4 350x350
#####################################################################
[printer]
kinematics: corexy

##  speed test with G0 X300 Y300 F9000 is ok     
##  F9000 => 9000/60=150 mm/s. 
max_velocity: 1000    # 967  according to auto_speed  		                      
max_accel: 4500       # 78350 according to auto_speed  			
max_z_velocity: 25 			
max_z_accel: 350
square_corner_velocity: 5.0

[heater_bed]
heater_pin: PA1
sensor_pin: PB1 # THB 
sensor_type: ATC Semitec 104GT-2
# control: PID
min_temp: 0
max_temp: 130

##------------------------------------------------
##  CONTROLER FAN
##------------------------------------------------
##  Controller cooling fan (one may define any number of sections with a "controller_fan" prefix). 
##  A "controller fan" is a fan that will be enabled whenever its associated heater or its associated stepper driver is active. 
##  The fan will stop whenever an idle_timeout is reached to ensure no overheating will occur after deactivating a watched component.
##  See the "fan" section for a description of the above parameters.
##  https://www.klipper3d.org/Config_Reference.html?h=fan#fan_generic

[controller_fan my_controller_fan1]
pin: PF9
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:

fan_speed: 1.0
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver is active.
#   The default is 1.0
idle_timeout: 30
#   The amount of time (in seconds) after a stepper driver or heater
#   was active and the fan should be kept running. The default
#   is 30 seconds.
#idle_speed:
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver was active and
#   before the idle_timeout is reached. The default is fan_speed.
#heater:

stepper: stepper_x, stepper_y, stepper_z, stepper_z1, stepper_z2, stepper_z3
#   Name of the config section defining the heater/stepper that this fan
#   is associated with. If a comma separated list of heater/stepper names
#   is provided here, then the fan will be enabled when any of the given
#   heaters/steppers are enabled. The default heater is "extruder", the
#   default stepper is all of them.
##------------------------------------------------

[controller_fan my_controller_fan2]
pin: PF6
fan_speed: 1.0
idle_timeout: 30
stepper: stepper_x, stepper_y, stepper_z, stepper_z1, stepper_z2, stepper_z3

[shaketune]  
## https://github.com/Frix-x/klippain-shaketune
## https://github.com/Frix-x/klippain-shaketune/blob/main/docs/README.md
##
# result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
# number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
# keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.

##------------------------------------------------
#####################################################################
##  EBB-sb-rp2040-canbus-v1.0.
#####################################################################
#[sample-bigtreetech-ebb-sb-rp2040-canbus-v1.0.cfg]

# This file contains common pin mappings for the BIGTREETECH EBBCan
# Canbus board. To use this config, the firmware should be compiled for the
# RP2040 with "USB" or "CAN bus (on gpio4/gpio5)".
# The "EBB Can" micro-controller will be used to control the components on the nozzle.

# See docs/Config_Reference.md for a description of parameters.

### For ENN2209
# [temperature_sensor EBB_NTC]
# sensor_type: Generic 3950
# sensor_pin: EBBCan:gpio28    

[adxl345]
### EBB209 config
# cs_pin: EBBCan:gpio1
# spi_software_sclk_pin: EBBCan:gpio2
# spi_software_mosi_pin: EBBCan:gpio0
# spi_software_miso_pin: EBBCan:gpio3
# #axes_map: x,y,x     # commented out for Shake Tune AXES_MAP_CALIBRATION

### EBB36 config
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: -x,-y,-z  ### To be checked


[resonance_tester]
probe_points: 175, 175, 20
accel_chip: adxl345

[extruder]
###  EBB2209 config
# step_pin: EBBCan:gpio18
# dir_pin:  EBBCan:gpio19
# enable_pin: !EBBCan:gpio17
# microsteps: 16
# rotation_distance: 4.594   # 4.417 => subsequent_mark_distance = 18.mm  (initial_mark_distance 70 - G1 E50 F60)
# nozzle_diameter: 0.400
# filament_diameter: 1.750
# heater_pin: EBBCan:gpio7

### EBB36 config
step_pin: EBBCan:PD0
dir_pin: !EBBCan:PD1
enable_pin: !EBBCan:PD2
heater_pin: EBBCan: PB13
sensor_pin: EBBCan: PA3
sensor_type: ATC Semitec 104NT-4-R025H42G
# control: PID
min_temp: 150
max_temp: 300

### To be checked
# max_extrude_only_distance=101
microsteps: 16
#  rotation_distance: 4.594   # 4.417 => subsequent_mark_distance = 18.mm  (initial_mark_distance 70 - G1 E50 F60)  ## STEALTHBURNER extruder
rotation_distance: 3.433   ## H2V2S extruder, mesuré 3.5222418  
nozzle_diameter: 0.400
filament_diameter: 1.750

### To be checked
# [temperature_sensor EBBCan]
# sensor_type: temperature_mcu
# sensor_mcu: EBBCan
# min_temp: 0
# max_temp: 100

#max_extrude_cross_section:
#   Maximum area (in mm^2) of an extrusion cross section (eg,
#   extrusion width multiplied by layer height). This setting prevents
#   excessive amounts of extrusion during relatively small XY moves.
#   If a move requests an extrusion rate that would exceed this value
#   it will cause an error to be returned. The default is: 4.0 * nozzle_diameter^2

# {% if hotend_type = "revo" %}
sensor_type: ATC Semitec 104NT-4-R025H42G
# sensor_pin: EBBCan:gpio27    # EBB2209 config TH0
sensor_pin: EBBCan:PA3 # EBB36 config TH0    
# {% endif %}

# {% if hotend_type = "V6" %}
# sensor_type: MAX31865
# sensor_pin: EBBCan:gpio9
# spi_software_sclk_pin: EBBCan:gpio10
# spi_software_mosi_pin: EBBCan:gpio8    # not connected
# spi_software_miso_pin: EBBCan:gpio11   # not connected
# rtd_nominal_r: 100
# rtd_reference_r: 430
# rtd_num_of_wires: 2
# {% endif %}

#control: pid
min_temp: 0
max_temp: 350
min_extrude_temp = 180   # 0 for testing without hotend, 180 oterwise 

[tmc2209 extruder]
# uart_pin: EBBCan:gpio20   ### EBB2209 config
 uart_pin: EBBCan:PA15   ### EBB36 config

run_current: 0.650
stealthchop_threshold: 999999
interpolate: true


[fan]      hotend_fan
# pin: GPIO14  # EBB2209 config
pin: EBBCan:PA1 # EBB36 config
off_below: 0.10

[heater_fan extruder_fan]
# pin: EBBCan:gpio13 # EBB2209 config
pin: EBBCan:PA0  # EBB36 confif
max_power: 1.0
heater: extruder
heater_temp: 50.0
fan_speed:1.0

#[fan_generic 4W_FAN0]  # EBB2209 config
#pin: EBBCan:gpio15 
#pin: {4W_FAN0_pin} 
#tachometer_pin: EBBCan:gpio12
#tachometer_ppr: 1

#[neopixel hotend_rgb]   ## Defined in tealthburner_leds.cfg
#pin: EBBCan:gpio16

#[bltouch]
#sensor_pin: ^EBBCan:gpio21
#control_pin: EBBCan:gpio22

#[heater_fan exhaust_fan]
[fan_generic exhaust_fan]
##	Exhaust fan - CNC_FAN3
## https://docs.vorondesign.com/community/howto/alchemyEngine/chamber_temperature_exhaust_fan.html
## https://github.com/VoronDesign/Voron-2/blob/Voron2.4/firmware/klipper_configurations/M8P/Voron2_M8P-v2.0_config.cfg
pin: PF8
#max_power: 1.0
#shutdown_speed: 0.0
#kick_start_time: 5.0
#heater: heater_bed
#heater_temp: 60
#fan_speed: 1.0

# [probe]   ## with TAP defined if tap_probe.cfg


# --- Voron Tap as Z endstop only ---
# --- Macro to home Z with Tap-like behavior ---
[gcode_macro HOME_Z_WITH_TAP]
gcode:
    # --------------------
    # according to copilot
    # --------------------
    # {% set PROBE_TEMP = 150 %}
    # M104 S{PROBE_TEMP}       ; Heat nozzle to probe temp
    # M109 S{PROBE_TEMP}       ; Wait for temp
    # G91                      ; Relative mode
    # G1 Z10 F600              ; Lift Z
    # G90                      ; Absolute mode
    # G28 Z                    ; Home Z using Tap endstop
    # # Simulate Tap's retract and sample behavior
    # G91
    # G1 Z3 F600
    # G90
    # --------------------
    
    {% set PROBE_TEMP = 150 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}
    



[filament_switch_sensor switch_sensor]
switch_pin: ^PF0          #  EBBCan:gpio24
#  EBBCan:gpio24  : end-stop port 
#  La broche sur laquelle l'interrupteur est connecté.
#  Ce paramètre doit être fourni.
    
pause_on_runout: True
#  Lorsque défini sur True, une PAUSE sera exécutée immédiatement après qu'un runout
#  soit détecté. Notez que si pause_on_runout est False et que le runout_gcode est omis,
#  la détection du runout est désactivée. Par défaut, est True.

runout_gcode: 
#  Une liste de commandes G-Code à exécuter après la détection d'une fin de filament.
#  Voir docs/Command_Templates.md pour le format G-Code. Si pause_on_runout est
#  réglé sur True, ce G-code sera exécuté après la fin de la PAUSE. Par défaut, aucune
#    commande G-Code n'est exécutée.
    RESPOND MSG="Filament Switch runnout detected" COLOR="success"
    CHANGE_FILAMENT

insert_gcode:
#  Une liste de commandes G-Code à exécuter après qu'une insertion de filament soit détectée.
#  Voir docs/Command_Templates.md pour le format G-Code. La valeur par défaut est de
#  n'exécuter aucune commande G-Code, ce qui désactive la détection de l'insertion.
    RESPOND MSG="Filament Switch inserted" COLOR="success"
    
event_delay:  3.0
#    La durée minimale en secondes à attendre entre les événements.
#    Des événements déclenchés durant cette période seront silencieusement ignorés.
#    La valeur par défaut est de 3 secondes.
pause_delay: 0.5
#    Le délai, en secondes, entre l'envoi de la commande de pause et l'exécution du runout_gcode.
#    Il peut être utile d'augmenter ce délai si OctoPrint présente un comportement étrange lors de
#    la pause. La valeur par défaut est 0.5 secondes.


[filament_motion_sensor encoder_sensor]
# switch_pin: !EBBCan:gpio24  # end-stop port
switch_pin: ^PC15    # ^EBBCan:gpio6      # IND port

detection_length: 10  # 2.88 This can be adjusted to your desired level of sensitivity. 10 is a recommended value to prevent flow dropoff false triggers.
extruder: extruder
pause_on_runout: True # This can be set to false to debug false positives putting the sensor in "monitor mode". The printer will not pause but it will run the runout_gcode below.
event_delay: 3.0
pause_delay: 2  # 0.5
runout_gcode:
    RESPOND MSG="Filament encoder runnout detected"
    CHECK_FILAMENT
    
insert_gcode:
    RESPOND MSG="Filament encoder detected"


[delayed_gcode DISABLEFILAMENTSENSOR] ; This will disable the SFS 1 second after klipper starts
initial_duration: 1
gcode:
    SFS_DISABLE
    # SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0 

[respond]   
## https://www.reddit.com/r/klippers/comments/y8rara/what_command_prints_text_to_the_console_id_like/
## https://www.klipper3d.org/G-Codes.html?h=respond#respond_1
default_type: echo
default_prefix: 

#####################################################################
#   MACROS
#####################################################################
[gcode_macro _CURA_SET_PRINT_STATS_INFO]
gcode:
  {% if params.LAYER_COUNT is defined %}
    SET_PRINT_STATS_INFO TOTAL_LAYER={params.LAYER_COUNT}
  {% endif %}
  {% if params.LAYER is defined %}
    SET_PRINT_STATS_INFO CURRENT_LAYER={(params.LAYER | int) + 1}
  {% endif %}

[gcode_macro RESPOND]
rename_existing: BASE_RESPOND
gcode:
  {% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}

  {% if params.PREFIX is defined %}
    {% set prefix = 'PREFIX=' + params.PREFIX|string %}
  {% endif %}

  {% if params.TYPE is defined %}
      {% if params.TYPE in ('echo', 'echo_no_space', 'command', 'error') and params.TYPE != '' %}    
          {% set type = 'TYPE=' + params.TYPE|string %}
      {% else %}
          BASE_RESPOND TYPE=error MSG="RESPOND TYPE '{params.TYPE}' is invalid. Must be one of 'echo', 'command' or 'error'"
      {% endif %}
  {% endif %}
        
  {% if params.MSG is defined %}   
    {% set msg = 'MSG="'+ params.MSG + '"'|string %}
  {% endif %}

  {% if params.COLOR is defined %}
      {% set color = params.COLOR|lower %}

      {% if color in colors %}
          {% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
  
      {% else %}
          BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
      {% endif %}
       
  {% endif %}
  BASE_RESPOND {prefix} {type} {msg}
  
#############################################################################
#   DYNAMIC MACROS
#   Send: DYNAMIC_MACRO after saving dynamic macro files, no need to restart
##  https://github.com/3DCoded/DynamicMacros
##  https://dynamicmacros.3dcoded.xyz/tutorial/
##  https://dynamicmacros.3dcoded.xyz/setup/
#############################################################################
[dynamicmacros]
configs: dynamic.cfg ## , eddy_macros.cfg  # You can add more files to this list, separated by commas.

 
#####################################################################
# 	Displays
#####################################################################

[virtual_sdcard]
path: ~/printer_data/gcodes
[display_status]

#####################################################################
##  various configs
#####################################################################

[pause_resume]

[gcode_arcs]
resolution: 0.1

[exclude_object]

[gcode_macro G29]
gcode:
    BED_MESH_CALIBRATE ADAPTATIV=1 ADAPTATIVE_MARGIN=5
    G90
    G0 Y20
    G0 X160 Y160
    

## 	Uncomment the display that you have
#--------------------------------------------------------------------

#[display]
##	RepRapDiscount 128x64 Full Graphic Smart Controller
#lcd_type: st7920
#cs_pin: EXP1_4
#sclk_pin: EXP1_5
#sid_pin: EXP1_3
#menu_timeout: 40
#encoder_pins: ^EXP2_5, ^EXP2_3
#click_pin: ^!EXP1_2

#[output_pin beeper]
#pin: EXP1_1

#--------------------------------------------------------------------

#[display]
##	mini12864 LCD Display
#lcd_type: uc1701
#cs_pin: EXP1_3
#a0_pin: EXP1_4
#rst_pin: EXP1_5
#encoder_pins: ^EXP2_5, ^EXP2_3
#click_pin: ^!EXP1_2
#contrast: 63
#spi_software_miso_pin: EXP2_1
#spi_software_mosi_pin: EXP2_6
#spi_software_sclk_pin: EXP2_2

#[neopixel btt_mini12864]
##	To control Neopixel RGB in mini12864 display
#pin: EXP1_6
#chain_count: 3
#initial_RED: 0.1
#initial_GREEN: 0.5
#initial_BLUE: 0.0
#color_order: RGB

##	Set RGB values on boot up for each Neopixel. 
##	Index 1 = display, Index 2 and 3 = Knob
#[delayed_gcode setdisplayneopixel]
#initia#l_duration: 1
#gcode:
#       SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
#       SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
#       SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 
       

[input_shaper]
shaper_freq_x: 87.4     # center frequency for the X axis filter
shaper_type_x: 2hump_ei # filter type for the X axis
shaper_freq_y: 40.2     # center frequency for the Y axis filter
shaper_type_y: mzv      # filter type for the Y axis
damping_ratio_x: 0.088  # damping ratio for the X axis
damping_ratio_y: 0.057  # damping ratio for the Y axis

#--------------------------------------------------------------------

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 27.444
#*# pid_ki = 2.951
#*# pid_kd = 63.806
#*# control = pid
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.356
#*# pid_ki = 3.514
#*# pid_kd = 303.904
#*#
#*# [probe]
#*# z_offset = -0.875
