## ----------------------------------------------------------------------------------------------------------
## De ChatGPT Afficher Z_Offset Klipper fro EDDY mode
## ----------------------------------------------------------------------------------------------------------

# Int√©gration dans Cura 5.9
# üîπ a) Start G-code
# Dans Cura ‚Üí Machine Settings ‚Üí Start G-code, vers la fin (juste avant les mouvements du 1er layer), ajoute :
# ; First layer monitoring start
# FL_INIT H={layer_height_0}
# üîπ b) Appeler FL_SAMPLE pendant le 1er layer
# Le plus simple (et safe) :
# Cura ‚Üí Extensions ‚Üí Post Processing ‚Üí Modify G-Code
# Ajoute un script Search and Replace :
# Search for : G1
# Replace with :
# FL_SAMPLE\nG1
# ‚Üí √áa appellera FL_SAMPLE tr√®s souvent, mais comme la macro ignore tout ce qui est au-dessus du first layer (z > nominal*1.5),
# elle ne fera vraiment des mesures que sur le 1er layer.
# Si tu veux limiter la fr√©quence, tu peux plut√¥t chercher ;TYPE:WALL-OUTER ou autre, mais la version ci-dessus est simple et efficace.
# üîπ c) Fin du first layer : rapport
# Toujours dans Post Processing, ajoute un 2e Search and Replace :
# Search: ;LAYER:1
# Replace: FL_REPORT\n;LAYER:1
# ‚Üí √Ä la mont√©e vers le layer 1, le rapport s‚Äôaffiche.
# Si tu es en OBS / devant l‚Äô√©cran, tu peux alors d√©cider :
# FL_APPLY
# pour corriger en live.


# R√©sum√© du workflow en pratique
# Tu ajoutes les macros FL_* dans macros.cfg
# Tu ajoutes une ligne dans le Start G-code du slicer ‚Üí FL_INIT H=...
# Tu fais un Search & Replace pour injecter FL_SAMPLE (Cura) ou macros de couche (Prusa)
# Tu lances une impression :
# pendant le first layer ‚Üí FL_SAMPLE mesure automatiquement
# au passage au 2e layer ‚Üí FL_REPORT affiche :
# Nominal / mesur√© / verdict / delta
# Tu tapes :
# FL_APPLY
# pour corriger en live, si tu es d‚Äôaccord avec la suggestion.
# 
# ## -------------------------------------------------------------------

[gcode_macro FL_INIT]
# Re√ßoit la vraie hauteur de first layer du slicer (H=...)
# R√©initialise les stats
gcode:
    {% set h = params.H|default(0.2)|float %}
    SET_GCODE_VARIABLE MACRO=FL_SAMPLE VARIABLE=nominal VALUE={h}
    SET_GCODE_VARIABLE MACRO=FL_SAMPLE VARIABLE=min_th VALUE=999
    SET_GCODE_VARIABLE MACRO=FL_SAMPLE VARIABLE=max_th VALUE=-999
    RESPOND MSG="FL_INIT : first layer nominal = {h} mm"

[gcode_macro FL_SAMPLE]  
## Macro FL_SAMPLE ‚Äî √† appeler plusieurs fois pendant le layer 0
# Macro FL_SAMPLE ‚Äî √† appeler plusieurs fois pendant le layer 0
# Calcule √©paisseur r√©elle √† partir de :
#   Z actuel
#   z_offset (TAP)
# compensation mesh bilin√©aire (Eddy)
# Met √† jour min_th et max_th
# Ignore tout ce qui est au-dessus du premier layer

variable_nominal: 0.2
variable_min_th: 999
variable_max_th: -999
gcode:
    {% set nominal = nominal %}
    {% set min_th = min_th %}
    {% set max_th = max_th %}

    {% set cf = printer.configfile.settings %}
    {% set zoff = cf.stepper_z.position_endstop %}

    {% set pos = printer.toolhead.position %}
    {% set x = pos.x %}
    {% set y = pos.y %}
    {% set z = pos.z %}

    # --- ignore si au-dessus du premier layer ---
    {% if z > nominal * 1.5 %}
        RESPOND MSG="FL_SAMPLE : ignor√© (Z={z} > first layer)"
    {% else %}
        # --- mesh bilin√©aire ---
        {% set bm = printer.bed_mesh if (printer.bed_mesh is defined and printer.bed_mesh.profile_name is not none) else None %}
        {% set mz = 0 %}

        {% if bm %}
            {% set mesh = bm.mesh_matrix %}
            {% set nx = mesh|length %}
            {% set ny = mesh[0]|length %}

            {% if nx >= 2 and ny >= 2 %}
                {% set x_min = bm.mesh_min[0] %}
                {% set y_min = bm.mesh_min[1] %}
                {% set x_max = bm.mesh_max[0] %}
                {% set y_max = bm.mesh_max[1] %}

                {% set sx = (x_max - x_min) / (nx - 1) %}
                {% set sy = (y_max - y_min) / (ny - 1) %}

                {% if sx != 0 and sy != 0 %}
                    {% set fx = (x - x_min) / sx %}
                    {% set fy = (y - y_min) / sy %}

                    {% set ix = fx|int %}
                    {% set iy = fy|int %}

                    {% if ix < 0 %}{% set ix = 0 %}{% endif %}
                    {% if iy < 0 %}{% set iy = 0 %}{% endif %}
                    {% if ix > nx-2 %}{% set ix = nx-2 %}{% endif %}
                    {% if iy > ny-2 %}{% set iy = ny-2 %}{% endif %}

                    {% set tx = fx - ix %}
                    {% set ty = fy - iy %}

                    {% set z00 = mesh[ix][iy] %}
                    {% set z10 = mesh[ix+1][iy] %}
                    {% set z01 = mesh[ix][iy+1] %}
                    {% set z11 = mesh[ix+1][iy+1] %}

                    {% set mz = z00*(1-tx)*(1-ty)
                              + z10*tx*(1-ty)
                              + z01*(1-tx)*ty
                              + z11*tx*ty %}
                {% endif %}
            {% endif %}
        {% endif %}

        # --- √©paisseur r√©elle ---
        {% set ep = z - (zoff + mz) %}

        RESPOND MSG="FL_SAMPLE : Z={z}  z_off={zoff}  mesh={mz}  √©paisseur={ep}"

        # mise √† jour statistiques
        {% if ep < min_th %}
            SET_GCODE_VARIABLE MACRO=FL_SAMPLE VARIABLE=min_th VALUE={ep}
        {% endif %}
        {% if ep > max_th %}
            SET_GCODE_VARIABLE MACRO=FL_SAMPLE VARIABLE=max_th VALUE={ep}
        {% endif %}
    {% endif %}

[gcode_macro FIRSTLAYER_APPLY]
gcode:
    {% set nominal = 0.2 %}
    {% set min_ep = printer["gcode_macro FIRSTLAYER_CHECK"].min_thickness %}
    {% set max_ep = printer["gcode_macro FIRSTLAYER_CHECK"].max_thickness %}
    {% set ep = (min_ep + max_ep) / 2 %}
    {% set zoff = printer.configfile.settings.stepper_z.position_endstop %}
    {% set correction = nominal - ep %}
    {% set new_zoff = zoff + correction %}

    RESPOND MSG="Applying new z_offset = {new_zoff}"

    SAVE_CONFIG

[gcode_macro FIRSTLAYER_START]
gcode:
    SET_GCODE_VARIABLE MACRO=FIRSTLAYER_START VARIABLE=active VALUE=True
    SET_GCODE_VARIABLE MACRO=FIRSTLAYER_CHECK VARIABLE=min_thickness VALUE=999
    SET_GCODE_VARIABLE MACRO=FIRSTLAYER_CHECK VARIABLE=max_thickness VALUE=-999
    RESPOND MSG="First layer monitoring activated"

[gcode_macro FIRSTLAYER_CHECK]
variable_min_thickness: 999
variable_max_thickness: -999
gcode:
    {% set zoff = printer.configfile.settings.stepper_z.position_endstop %}
    {% set pos = printer.toolhead.position %}
    {% set x = pos.x %}
    {% set y = pos.y %}
    {% set z = pos.z %}

    {% set first_layer_nominal = 0.2 %}
    
    {% set bm = printer.bed_mesh if (printer.bed_mesh is defined and printer.bed_mesh.profile_name is not none) else None %}
    {% if bm %}
        {% set mesh = bm.mesh_matrix %}
        {% set nx = mesh|length %}
        {% set ny = mesh[0]|length %}
        {% if nx >= 2 and ny >= 2 %}
            {% set x_min = bm.mesh_min[0] %}
            {% set y_min = bm.mesh_min[1] %}
            {% set x_max = bm.mesh_max[0] %}
            {% set y_max = bm.mesh_max[1] %}

            {% set sx = (x_max - x_min) / (nx - 1) %}
            {% set sy = (y_max - y_min) / (ny - 1) %}

            {% set fx = (x - x_min) / sx %}
            {% set fy = (y - y_min) / sy %}

            {% set ix = fx|int %}
            {% set iy = fy|int %}
            {% if ix < 0 %}{% set ix = 0 %}{% endif %}
            {% if iy < 0 %}{% set iy = 0 %}{% endif %}
            {% if ix > nx-2 %}{% set ix = nx-2 %}{% endif %}
            {% if iy > ny-2 %}{% set iy = ny-2 %}{% endif %}

            {% set tx = fx - ix %}
            {% set ty = fy - iy %}

            {% set z00 = mesh[ix][iy] %}
            {% set z10 = mesh[ix+1][iy] %}
            {% set z01 = mesh[ix][iy+1] %}
            {% set z11 = mesh[ix+1][iy+1] %}

            {% set mz = z00*(1-tx)*(1-ty)
                      + z10*tx*(1-ty)
                      + z01*(1-tx)*ty
                      + z11*tx*ty %}
        {% else %}
            {% set mz = 0 %}
        {% endif %}
    {% else %}
        {% set mz = 0 %}
    {% endif %}

    {% set ep = z - (zoff + mz) %}
    
    # track min & max
    {% if ep < min_thickness %} SET_GCODE_VARIABLE MACRO=FIRSTLAYER_CHECK VARIABLE=min_thickness VALUE={ep} {% endif %}
    {% if ep > max_thickness %} SET_GCODE_VARIABLE MACRO=FIRSTLAYER_CHECK VARIABLE=max_thickness VALUE={ep} {% endif %}

[gcode_macro FIRSTLAYER_END]
# Macro (C) ‚Äî FIRSTLAYER_END + indicateur + auto-correction

gcode:
    {% set nominal = 0.2 %}
    {% set min_ep = printer["gcode_macro FIRSTLAYER_CHECK"].min_thickness %}
    {% set max_ep = printer["gcode_macro FIRSTLAYER_CHECK"].max_thickness %}

    {% set ep = (min_ep + max_ep) / 2 %}
    {% set zoff = printer.configfile.settings.stepper_z.position_endstop %}
    {% set correction = nominal - ep %}

    RESPOND MSG="--------------------------------"
    RESPOND MSG="First Layer Report"
    RESPOND MSG="Nominal thickness = {nominal}"
    RESPOND MSG="Measured = {ep}"

    {% if ep < nominal*0.70 %}
        RESPOND MSG="‚ùå Too squished"
    {% elif ep > nominal*1.30 %}
        RESPOND MSG="‚ùå Too high"
    {% else %}
        RESPOND MSG="‚úî Good first layer"
    {% endif %}

    RESPOND MSG="Suggested Z-offset correction = {correction}"
    RESPOND MSG="--------------------------------"
    RESPOND MSG="Run FIRSTLAYER_APPLY to apply the correction"

[gcode_macro FL_REPORT]
# Macro FL_REPORT ‚Äî fin du first layer / demande de bilan
# Calcule √©paisseur moyenne
# Compare √† nominal
# Donne un verdict : ‚úÖ Bon / ‚ùå √©cras√© / ‚ö†Ô∏è trop haut
# Calcule la correction sugg√©r√©e pour le z_offset
# Stocke la correction dans FL_DATA.delta pour l‚Äôappliquer ensuite

gcode:
    {% set fl = printer["gcode_macro FL_SAMPLE"] %}
    {% set nominal = fl.nominal %}
    {% set min_ep = fl.min_th %}
    {% set max_ep = fl.max_th %}

    {% if min_ep == 999 or max_ep == -999 %}
        RESPOND MSG="FL_REPORT : aucune mesure prise (FL_SAMPLE non appel√© ou hors first layer)"
    {% else %}
        {% set ep = (min_ep + max_ep) / 2 %}
        {% set zoff = printer.configfile.settings.stepper_z.position_endstop %}
        {% set delta = nominal - ep %}

        {% set low_limit = nominal * 0.7 %}
        {% set high_limit = nominal * 1.3 %}

        RESPOND MSG="------------------------------"
        RESPOND MSG="First Layer Report"
        RESPOND MSG="Nominal          = {nominal} mm"
        RESPOND MSG="Mesured (avg)    = {ep} mm"

        {% if ep < low_limit %}
            {% set verdict = "‚ùå Trop √©cras√©" %}
        {% elif ep > high_limit %}
            {% set verdict = "‚ùå Trop haut" %}
        {% else %}
            {% set verdict = "‚úÖ Bon first layer" %}
        {% endif %}

        RESPOND MSG="Verdict          = {verdict}"
        RESPOND MSG="Current z_offset = {zoff}"
        RESPOND MSG="Suggested delta  = {delta} (nouveau z_off = {zoff + delta})"
        RESPOND MSG="------------------------------"
        RESPOND MSG="Pour appliquer la correction : FL_APPLY"

        SET_GCODE_VARIABLE MACRO=FL_APPLY VARIABLE=last_delta VALUE={delta}
    {% endif %}


[gcode_macro FL_APPLY]
# Macro FL_APPLY ‚Äî auto-correction en live, mais seulement si tu confirmes
# Applique la correction en RAM via SET_GCODE_OFFSET
# Tu pourras ensuite d√©cider si tu fais SAVE_CONFIG √† la main.

variable_last_delta: 0.0
gcode:
    {% set delta = last_delta %}
    {% set zoff = printer.configfile.settings.stepper_z.position_endstop %}
    {% set new_zoff = zoff + delta %}

    RESPOND MSG="FL_APPLY : application live de Z_ADJUST={delta}"
    SET_GCODE_OFFSET Z_ADJUST={delta} MOVE=1

    RESPOND MSG="Nouveau z_offset effectif (RAM) ‚âà {new_zoff}"
    RESPOND MSG="Si c'est bon : ajuste dans printer.cfg puis SAVE_CONFIG"
